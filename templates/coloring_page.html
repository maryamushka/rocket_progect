<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® –†–∞—Å–∫—Ä–∞—Å–∫–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px 25px;
            background: linear-gradient(45deg, #ff0066, #ff5500);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.1rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(255, 0, 102, 0.3);
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(255, 0, 102, 0.5);
        }

        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
        .coloring-container {
            max-width: 95vw;
            margin: 0 auto;
            padding: 20px;
        }

        /* –ó–ê–ì–û–õ–û–í–û–ö */
        .coloring-header {
            text-align: center;
            margin: 70px 0 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 3px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .coloring-title {
            font-size: 2.2rem;
            color: #ffff00;
            margin-bottom: 10px;
            text-shadow: 0 0 10px yellow;
            font-family: 'Comic Sans MS', cursive;
        }

        .coloring-subtitle {
            color: #00ffaa;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –û–ë–õ–ê–°–¢–¨ */
        .workspace {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        @media (min-width: 1200px) {
            .workspace {
                flex-direction: row;
            }

            .canvas-section {
                flex: 3;
            }

            .controls-section {
                flex: 1;
                max-width: 400px;
            }
        }

        /* –•–û–õ–°–¢ */
        .canvas-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 15px;
            border: 3px solid #ff00ff;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
            width: 100%;
        }

        .coloring-canvas {
            border: 3px solid #00ffff;
            border-radius: 15px;
            background: white;
            cursor: none;
            max-width: 100%;
            height: auto;
            display: block;
            touch-action: none;
        }

        .canvas-info {
            margin-top: 15px;
            color: #aaa;
            font-size: 0.9rem;
            text-align: center;
        }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .controls-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid #ffff00;
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.3);
            backdrop-filter: blur(10px);
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* –ü–ê–õ–ò–¢–†–ê –¶–í–ï–¢–û–í */
        .palette-section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #00ffff;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        @media (max-width: 768px) {
            .color-palette {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .color-option:hover {
            transform: translateY(-3px) scale(1.1);
        }

        .color-option.active {
            border-color: white;
            box-shadow: 0 0 15px currentColor;
            transform: scale(1.1);
        }

        /* –†–ê–ó–ú–ï–† –ö–ò–°–¢–ò */
        .brush-section {
            margin-bottom: 25px;
        }

        .brush-size-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .brush-size-btn {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ffaa;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .brush-size-btn:hover {
            background: rgba(0, 255, 170, 0.2);
            transform: translateY(-3px);
        }

        .brush-size-btn.active {
            background: #00ffaa;
            color: black;
            border-color: #00ffaa;
            box-shadow: 0 0 15px #00ffaa;
        }

        /* –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ */
        .tools-section {
            margin-bottom: 25px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .tool-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ff00ff;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .tool-btn:hover {
            background: rgba(255, 0, 255, 0.2);
            transform: translateY(-3px);
        }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô */
        .actions-section {
            margin-bottom: 25px;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* –ö–£–†–°–û–† –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø */
        .brush-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.8);
            background: rgba(255, 255, 255, 0.3);
            display: none;
        }

        /* –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò - –£–ü–†–û–©–Å–ù */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(0, 255, 255, 0.3);
            border-top-color: #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #00ffff;
            font-size: 1.2rem;
            text-align: center;
            max-width: 300px;
            line-height: 1.5;
        }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(42,42,90,0.9));
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            border-left: 4px solid gold;
            max-width: 300px;
            z-index: 10000;
            animation: slideIn 0.3s, slideOut 0.3s 2.7s;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* –ü–†–û–ì–†–ï–°–° –ë–ê–† */
        .progress-bar {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }
    </style>
</head>
<body class="coloring-page">
    <!-- –ó–í–ï–ó–î–ù–û–ï –ü–û–õ–ï -->
    <div class="starfield"></div>

    <!-- –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î -->
    <button class="back-button" onclick="window.location.href='/coloring_gallery'"
            title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–∞–ª–µ—Ä–µ–µ —Ä–∞—Å–∫—Ä–∞—Å–æ–∫">
        <i class="fas fa-arrow-left"></i> –í–´–ë–†–ê–¢–¨ –î–†–£–ì–£–Æ
    </button>

    <!-- –ö–£–†–°–û–† –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø -->
    <div class="brush-cursor" id="brush-cursor"></div>

    <!-- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">üé® –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–∫—Ä–∞—Å–∫—É...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="coloring-container">
        <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
        <div class="coloring-header">
            <h1 class="coloring-title" id="coloring-title">üé® –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –†–ê–°–ö–†–ê–°–ö–ê</h1>
            <div class="coloring-subtitle" id="coloring-subtitle">
                –í—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç –∏ —Ä–∏—Å—É–π –ø—Ä—è–º–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ! –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –∫–∏—Å—Ç–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —à–µ–¥–µ–≤—Ä–∞! ‚ú®
            </div>
        </div>

        <!-- –†–ê–ë–û–ß–ê–Ø –û–ë–õ–ê–°–¢–¨ -->
        <div class="workspace">
            <!-- –•–û–õ–°–¢ -->
            <div class="canvas-section">
                <div class="canvas-container">
                    <canvas id="coloring-canvas" width="800" height="600" class="coloring-canvas">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Canvas. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä.
                    </canvas>
                    <div class="canvas-info">
                        <i class="fas fa-mouse-pointer"></i> –ö–ª–∏–∫–∞–π –∏ —Ä–∏—Å—É–π –º—ã—à–∫–æ–π –∏–ª–∏ –ø–∞–ª—å—Ü–µ–º
                    </div>
                </div>
            </div>

            <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
            <div class="controls-section">
                <div class="controls-panel">
                    <!-- –ü–ê–õ–ò–¢–†–ê –¶–í–ï–¢–û–í -->
                    <div class="palette-section">
                        <h3 class="section-title">
                            <i class="fas fa-palette"></i>
                            –ü–ê–õ–ò–¢–†–ê –¶–í–ï–¢–û–í
                        </h3>
                        <div class="color-palette" id="color-palette">
                            <!-- –¶–≤–µ—Ç–∞ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </div>
                    </div>

                    <!-- –†–ê–ó–ú–ï–† –ö–ò–°–¢–ò -->
                    <div class="brush-section">
                        <h3 class="section-title">
                            <i class="fas fa-brush"></i>
                            –†–ê–ó–ú–ï–† –ö–ò–°–¢–ò
                        </h3>
                        <div class="brush-size-selector" id="brush-size-selector">
                            <!-- –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–∏—Å—Ç–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã -->
                        </div>
                    </div>

                    <!-- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ -->
                    <div class="tools-section">
                        <h3 class="section-title">
                            <i class="fas fa-tools"></i>
                            –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
                        </h3>
                        <div class="tools-grid">
                            <button class="tool-btn" onclick="setBrushType('round')" title="–ö—Ä—É–≥–ª–∞—è –∫–∏—Å—Ç—å">
                                <i class="fas fa-circle"></i>
                                –ö–∏—Å—Ç—å
                            </button>
                            <button class="tool-btn" onclick="setBrushType('square')" title="–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∫–∏—Å—Ç—å">
                                <i class="fas fa-square"></i>
                                –ö–≤–∞–¥—Ä–∞—Ç
                            </button>
                            <button class="tool-btn" onclick="setBrushType('fill')" title="–ó–∞–ª–∏–≤–∫–∞ –æ–±–ª–∞—Å—Ç–∏">
                                <i class="fas fa-fill-drip"></i>
                                –ó–∞–ª–∏–≤–∫–∞
                            </button>
                            <button class="tool-btn" onclick="undoLastAction()" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ">
                                <i class="fas fa-undo"></i>
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>

                    <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
                    <div class="actions-section">
                        <h3 class="section-title">
                            <i class="fas fa-cogs"></i>
                            –î–ï–ô–°–¢–í–ò–Ø
                        </h3>
                        <div class="actions-grid">
                            <button class="action-btn" onclick="clearCanvas()"
                                    style="background: linear-gradient(45deg, #ff4444, #ff0000); color: white;"
                                    title="–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ä–∏—Å—É–Ω–æ–∫">
                                <i class="fas fa-eraser"></i>
                                –û–ß–ò–°–¢–ò–¢–¨
                            </button>
                            <button class="action-btn" onclick="saveDrawing()"
                                    style="background: linear-gradient(45deg, #44ff44, #00aa00); color: white;"
                                    title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –∏ –ø–æ–ª—É—á–∏—Ç—å –∑–≤—ë–∑–¥—ã">
                                <i class="fas fa-save"></i>
                                –°–û–•–†–ê–ù–ò–¢–¨
                            </button>
                            <button class="action-btn" onclick="downloadDrawing()"
                                    style="background: linear-gradient(45deg, #ffff44, #ffaa00); color: black;"
                                    title="–°–∫–∞—á–∞—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä">
                                <i class="fas fa-download"></i>
                                –°–ö–ê–ß–ê–¢–¨
                            </button>
                            <button class="action-btn" onclick="window.location.href='/coloring_gallery'"
                                    style="background: linear-gradient(45deg, #4444ff, #0000ff); color: white;"
                                    title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–∞–ª–µ—Ä–µ—é">
                                <i class="fas fa-images"></i>
                                –ì–ê–õ–ï–†–ï–Ø
                            </button>
                        </div>
                    </div>

                    <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–í–Å–ó–î–ê–• -->
                    <div style="background: rgba(255, 215, 0, 0.1); border-radius: 12px; padding: 15px; text-align: center; border: 2px solid gold; margin-top: 15px;">
                        <div style="color: gold; font-size: 1.1rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-star"></i>
                            –ü–û–õ–£–ß–ê–ô –ó–í–Å–ó–î–´!
                        </div>
                        <div style="color: #ffdd00; font-size: 0.9rem; line-height: 1.4;" id="stars-message">
                            ‚≠ê –ó–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∏—Å—É–Ω–∫–∞: +3 –∑–≤–µ–∑–¥—ã
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = '#ff0000';
        let brushSize = 10;
        let brushType = 'round';
        let originalImage = null;
        let lastX = 0;
        let lastY = 0;
        let undoStack = [];
        let brushCursor;

        // –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
        const colors = [
            '#ff0000', '#ff8800', '#ffff00', '#00ff00', '#00ffff',
            '#0088ff', '#8800ff', '#ff00ff', '#ffffff', '#cccccc',
            '#888888', '#000000', '#8b4513', '#ffd700', '#c0c0c0'
        ];

        // –ù–∞–∑–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
        const colorNames = [
            '–ö—Ä–∞—Å–Ω—ã–π', '–û—Ä–∞–Ω–∂–µ–≤—ã–π', '–ñ—ë–ª—Ç—ã–π', '–ó–µ–ª—ë–Ω—ã–π', '–ì–æ–ª—É–±–æ–π',
            '–°–∏–Ω–∏–π', '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–†–æ–∑–æ–≤—ã–π', '–ë–µ–ª—ã–π', '–°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π',
            '–¢—ë–º–Ω–æ-—Å–µ—Ä—ã–π', '–ß—ë—Ä–Ω—ã–π', '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π', '–ó–æ–ª–æ—Ç–æ–π', '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π'
        ];

        // –†–∞–∑–º–µ—Ä—ã –∫–∏—Å—Ç–∏
        const brushSizes = [3, 6, 10, 14, 18];

        // ========== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        async function initColoring() {
            console.log('üé® –ë—ã—Å—Ç—Ä–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∏...');

            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            canvas = document.getElementById('coloring-canvas');
            ctx = canvas.getContext('2d');
            brushCursor = document.getElementById('brush-cursor');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ä–∞–∑—É
            initColorPalette();
            initBrushSizes();
            initStats();
            setupBrushCursor();
            setupCanvasEvents();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loading-overlay').style.display = 'flex';
            updateProgress(20);

            // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏
            await loadColoringFast();

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            }, 300);

            console.log('‚úÖ –†–∞—Å–∫—Ä–∞—Å–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
        }

        // ========== –ë–´–°–¢–†–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –†–ê–°–ö–†–ê–°–ö–ò ==========
        async function loadColoringFast() {
            console.log('‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏...');

            updateProgress(40);

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞—Å–∫—Ä–∞—Å–∫–µ
            const selectedData = localStorage.getItem('selectedColoring');

            if (!selectedData) {
                console.log('‚ÑπÔ∏è –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞—Å–∫—Ä–∞—Å–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ');
                loadDefaultImageFast();
                updateProgress(100);
                return;
            }

            try {
                const coloring = JSON.parse(selectedData);
                console.log('üìã –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏:', coloring);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('coloring-title').textContent = `üé® ${coloring.name}`;
                document.getElementById('coloring-subtitle').textContent =
                    `–†–∞—Å–∫—Ä–∞—à–∏–≤–∞–µ–º: ${coloring.name}`;

                updateProgress(60);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ë–ï–ó –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤
                await loadImageSimple(coloring.path);

                updateProgress(100);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                loadDefaultImageFast();
                updateProgress(100);
            }
        }

        // ========== –ü–†–û–°–¢–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ==========
        function loadImageSimple(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();

                img.onload = function() {
                    console.log('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', imageUrl);
                    originalImage = img;

                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                    setupOptimalCanvasSize(img.width, img.height);

                    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ë–ï–ó –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤
                    drawImageSimple(img);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    saveState();

                    resolve();
                };

                img.onerror = function(error) {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:', error);
                    loadDefaultImageFast();
                    reject(error);
                };

                img.src = imageUrl;
            });
        }

        // ========== –†–ò–°–û–í–ê–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ë–ï–ó –û–ë–†–ê–ë–û–¢–ö–ò ==========
        function drawImageSimple(img) {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ü—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            console.log('üé® –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤');
        }

        // ========== –ë–´–°–¢–†–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –î–ï–§–û–õ–¢–ù–û–ì–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ==========
        function loadDefaultImageFast() {
            console.log('üé® –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ-—Ä–∞—Å–∫—Ä–∞—Å–∫—É –±—ã—Å—Ç—Ä–æ');

            document.getElementById('coloring-title').textContent = 'üé® –î–ï–ú–û –†–ê–ö–ï–¢–ê';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—É–º–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            setupOptimalCanvasSize(600, 500);
            drawDefaultRocketSimple();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            saveState();
        }

        // ========== –ü–†–û–°–¢–ê–Ø –†–ê–ö–ï–¢–ê ==========
        function drawDefaultRocketSimple() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ë–µ–ª—ã–π —Ñ–æ–Ω
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ö–æ–Ω—Ç—É—Ä —Ä–∞–∫–µ—Ç—ã (—á—ë—Ä–Ω—ã–π)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // –ü—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç—É—Ä —Ä–∞–∫–µ—Ç—ã
            const centerX = canvas.width / 2;
            const rocketHeight = canvas.height * 0.7;
            const rocketWidth = canvas.width * 0.3;

            ctx.beginPath();
            ctx.moveTo(centerX, canvas.height - 50);
            ctx.lineTo(centerX - rocketWidth/2, canvas.height - rocketHeight);
            ctx.lineTo(centerX - rocketWidth/2, 100);
            ctx.lineTo(centerX + rocketWidth/2, 100);
            ctx.lineTo(centerX + rocketWidth/2, canvas.height - rocketHeight);
            ctx.closePath();
            ctx.stroke();

            // –û–∫–Ω–æ
            ctx.beginPath();
            ctx.arc(centerX, canvas.height - rocketHeight * 0.6, 25, 0, Math.PI * 2);
            ctx.stroke();
        }

        // ========== –ù–ê–°–¢–†–û–ô–ö–ê –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ì–û –†–ê–ó–ú–ï–†–ê ==========
        function setupOptimalCanvasSize(imgWidth, imgHeight) {
            const container = document.querySelector('.canvas-container');
            const availableWidth = container.clientWidth - 30;
            const availableHeight = window.innerHeight - 250;

            let width, height;
            const aspectRatio = imgWidth / imgHeight;

            if (imgWidth > imgHeight) {
                width = Math.min(imgWidth, availableWidth);
                height = width / aspectRatio;
            } else {
                height = Math.min(imgHeight, availableHeight);
                width = height * aspectRatio;
            }

            // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–æ–ª—å—à–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            width = Math.min(imgWidth, Math.floor(width));
            height = Math.min(imgHeight, Math.floor(height));

            canvas.width = width;
            canvas.height = height;

            console.log(`üìè –†–∞–∑–º–µ—Ä canvas: ${width}x${height}`);
        }

        // ========== –ù–ê–°–¢–†–û–ô–ö–ê –ö–£–†–°–û–†–ê ==========
        function setupBrushCursor() {
            canvas.style.cursor = 'none';

            document.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;

                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    brushCursor.style.display = 'block';
                    brushCursor.style.left = x + 'px';
                    brushCursor.style.top = y + 'px';

                    // –ú–∞–ª–µ–Ω—å–∫–∏–π –∫—É—Ä—Å–æ—Ä –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                    brushCursor.style.width = brushSize + 'px';
                    brushCursor.style.height = brushSize + 'px';
                    brushCursor.style.background = currentColor;
                    brushCursor.style.border = '1px solid black';
                    brushCursor.style.borderRadius = brushType === 'square' ? '2px' : '50%';
                } else {
                    brushCursor.style.display = 'none';
                }
            });

            canvas.addEventListener('mouseenter', () => brushCursor.style.display = 'block');
            canvas.addEventListener('mouseleave', () => brushCursor.style.display = 'none');
        }

        // ========== –ù–ê–°–¢–†–û–ô–ö–ê –°–û–ë–´–¢–ò–ô ==========
        function setupCanvasEvents() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch —Å–æ–±—ã—Ç–∏—è
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    startDrawing(e.touches[0]);
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && isDrawing) {
                    draw(e.touches[0]);
                }
            });

            canvas.addEventListener('touchend', stopDrawing);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –†–ò–°–û–í–ê–ù–ò–Ø ==========
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);

            if (brushType === 'fill') {
                floodFill(lastX, lastY, currentColor);
                saveState();
                return;
            }

            brushCursor.style.opacity = '0.7';
        }

        function draw(e) {
            if (!isDrawing) return;

            const [x, y] = getCoordinates(e);

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            ctx.lineWidth = brushSize;
            ctx.lineCap = brushType === 'square' ? 'square' : 'round';
            ctx.strokeStyle = currentColor;
            ctx.lineJoin = 'round';

            // –†–∏—Å—É–µ–º
            ctx.lineTo(x, y);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(x, y);
            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.closePath();
                brushCursor.style.opacity = '1';
                saveState();
            }
        }

        // ========== –ó–ê–õ–ò–í–ö–ê ==========
        function floodFill(startX, startY, fillColor) {
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const targetColor = getPixelColor(data, startX, startY);
                const fillRgb = hexToRgb(fillColor);

                if (colorsEqual(targetColor, fillRgb)) return;

                const stack = [[startX, startY]];
                const visited = new Set();

                while (stack.length > 0) {
                    const [x, y] = stack.pop();
                    const key = `${x},${y}`;

                    if (visited.has(key)) continue;
                    if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;

                    const currentColor = getPixelColor(data, x, y);

                    if (colorsEqual(currentColor, targetColor)) {
                        setPixelColor(data, x, y, fillColor);
                        visited.add(key);

                        stack.push([x + 1, y]);
                        stack.push([x - 1, y]);
                        stack.push([x, y + 1]);
                        stack.push([x, y - 1]);
                    }
                }

                ctx.putImageData(imageData, 0, 0);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ª–∏–≤–∫–µ:', error);
                showNotification('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ª–∏–≤–∫—É', 'error');
            }
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.clientX !== undefined) {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            } else if (e.touches) {
                const touch = e.touches[0] || e;
                x = touch.clientX - rect.left;
                y = touch.clientY - rect.top;
            } else {
                x = e.offsetX;
                y = e.offsetY;
            }

            return [x, y];
        }

        function getPixelColor(data, x, y) {
            const index = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
            return {
                r: data[index],
                g: data[index + 1],
                b: data[index + 2],
                a: data[index + 3]
            };
        }

        function setPixelColor(data, x, y, hexColor) {
            const rgb = hexToRgb(hexColor);
            const index = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
            data[index] = rgb.r;
            data[index + 1] = rgb.g;
            data[index + 2] = rgb.b;
            data[index + 3] = 255;
        }

        function colorsEqual(c1, c2) {
            return c1.r === c2.r && c1.g === c2.g && c1.b === c2.b;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ê–õ–ò–¢–†–´ ==========
        function initColorPalette() {
            const palette = document.getElementById('color-palette');
            palette.innerHTML = '';

            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.backgroundColor = color;
                colorDiv.title = colorNames[index] || color;

                if (color === currentColor) {
                    colorDiv.classList.add('active');
                }

                colorDiv.addEventListener('click', () => {
                    selectColor(color, colorDiv);
                });

                palette.appendChild(colorDiv);
            });
        }

        // ========== –í–´–ë–û–† –¶–í–ï–¢–ê ==========
        function selectColor(color, element) {
            currentColor = color;

            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
            brushCursor.style.background = color;

            showNotification(`–í—ã–±—Ä–∞–Ω: ${element.title}`, 'info');
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ê–ó–ú–ï–†–û–í –ö–ò–°–¢–ò ==========
        function initBrushSizes() {
            const selector = document.getElementById('brush-size-selector');
            selector.innerHTML = '';

            brushSizes.forEach((size) => {
                const btn = document.createElement('button');
                btn.className = `brush-size-btn ${size === brushSize ? 'active' : ''}`;
                btn.title = `–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: ${size}px`;
                btn.textContent = size;

                btn.addEventListener('click', () => setBrushSize(size, btn));

                selector.appendChild(btn);
            });
        }

        // ========== –£–°–¢–ê–ù–û–í–ö–ê –†–ê–ó–ú–ï–†–ê –ö–ò–°–¢–ò ==========
        function setBrushSize(size, element = null) {
            brushSize = size;

            document.querySelectorAll('.brush-size-btn').forEach((btn, index) => {
                btn.classList.toggle('active', brushSizes[index] === size);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
            brushCursor.style.width = size + 'px';
            brushCursor.style.height = size + 'px';

            showNotification(`–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏: ${size}px`, 'info');
        }

        // ========== –£–°–¢–ê–ù–û–í–ö–ê –¢–ò–ü–ê –ö–ò–°–¢–ò ==========
        function setBrushType(type) {
            brushType = type;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –∫—É—Ä—Å–æ—Ä–∞
            brushCursor.style.borderRadius = type === 'square' ? '2px' : '50%';

            const typeNames = {
                'round': '–ö—Ä—É–≥–ª–∞—è –∫–∏—Å—Ç—å',
                'square': '–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∫–∏—Å—Ç—å',
                'fill': '–ó–∞–ª–∏–≤–∫–∞'
            };

            showNotification(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${typeNames[type]}`, 'info');
        }

        // ========== –û–¢–ú–ï–ù–ê –î–ï–ô–°–¢–í–ò–Ø ==========
        function undoLastAction() {
            if (undoStack.length > 1) {
                const state = undoStack[undoStack.length - 2];
                restoreState(state);
                undoStack.pop();
                showNotification('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
            } else {
                showNotification('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å', 'info');
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø ==========
        function saveState() {
            if (undoStack.length > 20) {
                undoStack.shift();
            }
            const state = ctx.getImageData(0, 0, canvas.width, canvas.height);
            undoStack.push(state);
        }

        function restoreState(state) {
            ctx.putImageData(state, 0, 0);
        }

        // ========== –û–ß–ò–°–¢–ö–ê –•–û–õ–°–¢–ê ==========
        function clearCanvas() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ä–∏—Å—É–Ω–æ–∫ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                if (originalImage) {
                    drawImageSimple(originalImage);
                } else {
                    drawDefaultRocketSimple();
                }
                saveState();
                showNotification('–•–æ–ª—Å—Ç –æ—á–∏—â–µ–Ω', 'info');
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ò–°–£–ù–ö–ê ==========
        async function saveDrawing() {
            try {
                const dataUrl = canvas.toDataURL('image/png');
                const savedDrawings = JSON.parse(localStorage.getItem('savedDrawings') || '[]');
                const drawingName = document.getElementById('coloring-title').textContent.replace('üé® ', '');

                savedDrawings.push({
                    url: dataUrl,
                    name: drawingName,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                });

                if (savedDrawings.length > 20) {
                    savedDrawings.shift();
                }

                localStorage.setItem('savedDrawings', JSON.stringify(savedDrawings));

                // –ù–∞—á–∏—Å–ª—è–µ–º –∑–≤—ë–∑–¥—ã
                const starsEarned = await awardStars();

                showNotification(`üé® –†–∏—Å—É–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω! +${starsEarned} –∑–≤—ë–∑–¥`, 'success');
                updateStarsMessage(starsEarned);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫', 'error');
            }
        }

        // ========== –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ó–í–Å–ó–î ==========
        async function awardStars() {
            let starsToAward = 3;

            const stats = JSON.parse(localStorage.getItem('coloringStats') || '{"totalColored": 0, "starsEarned": 0}');

            if (stats.totalColored === 0) {
                starsToAward += 2;
            }

            if (stats.totalColored > 0 && stats.totalColored % 5 === 0) {
                starsToAward += 5;
            }

            stats.totalColored++;
            stats.starsEarned += starsToAward;
            localStorage.setItem('coloringStats', JSON.stringify(stats));

            try {
                await fetch('/add_star', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        count: starsToAward,
                        reason: '–°–æ—Ö—Ä–∞–Ω–∏–ª —Ä–∞—Å–∫—Ä–∞—Å–∫—É'
                    })
                });

                return starsToAward;
            } catch (error) {
                return 3;
            }
        }

        // ========== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –†–ò–°–£–ù–ö–ê ==========
        function downloadDrawing() {
            const link = document.createElement('a');
            const drawingName = document.getElementById('coloring-title').textContent
                .replace('üé® ', '')
                .replace(/[^a-z–∞-—è—ë0-9]/gi, '_')
                .toLowerCase();

            const fileName = `—Ä–∞—Å–∫—Ä–∞—Å–∫–∞_${drawingName}_${Date.now()}.png`;
            link.download = fileName;
            link.href = canvas.toDataURL('image/png');
            link.click();

            showNotification('üì• –†–∏—Å—É–Ω–æ–∫ —Å–∫–∞—á–∞–Ω!', 'success');
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò ==========
        function initStats() {
            updateStarsMessage(0);
        }

        function updateStarsMessage(justEarned = 0) {
            const stats = JSON.parse(localStorage.getItem('coloringStats') || '{"totalColored": 0, "starsEarned": 0}');
            const message = document.getElementById('stars-message');

            if (justEarned > 0) {
                message.innerHTML = `
                    ‚úÖ <strong>–ü–æ–ª—É—á–µ–Ω–æ +${justEarned} –∑–≤—ë–∑–¥!</strong><br>
                    ‚≠ê –í—Å–µ–≥–æ —Ä–∞—Å–∫—Ä–∞—Å–æ–∫: ${stats.totalColored}<br>
                    ‚≠ê –í—Å–µ–≥–æ –∑–≤—ë–∑–¥: ${stats.starsEarned}
                `;
            } else {
                message.innerHTML = `
                    ‚≠ê –ó–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∏—Å—É–Ω–∫–∞: +3 –∑–≤–µ–∑–¥—ã<br>
                    ‚≠ê –ó–∞ –ø–µ—Ä–≤—É—é —Ä–∞—Å–∫—Ä–∞—Å–∫—É: +5 –∑–≤—ë–∑–¥<br>
                    ‚≠ê –ó–∞ 5 —Ä–∞—Å–∫—Ä–∞—Å–æ–∫: +10 –∑–≤—ë–∑–¥!<br>
                    –í—Å–µ–≥–æ —Ä–∞—Å–∫—Ä–∞—Å–æ–∫: ${stats.totalColored}
                `;
            }
        }

        // ========== –ü–†–û–ì–†–ï–°–° –ë–ê–† ==========
        function updateProgress(percent) {
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = percent + '%';
            }
        }

        // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';

            const borderColors = {
                'info': '#00ffff',
                'success': '#00ff00',
                'error': '#ff0000'
            };

            notification.style.borderLeftColor = borderColors[type] || '#00ffff';

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 1.2rem;">
                        ${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üí´'}
                    </div>
                    <div style="flex: 1; font-weight: bold;">${message}</div>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // ========== –ó–í–ï–ó–î–ù–û–ï –ü–û–õ–ï ==========
        function createStarfield() {
            const starfield = document.querySelector('.starfield');
            starfield.innerHTML = '';

            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.cssText = `
                    width: ${Math.random() * 2 + 1}px;
                    height: ${Math.random() * 2 + 1}px;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    opacity: ${Math.random() * 0.5 + 0.2};
                    animation-duration: ${Math.random() * 3 + 2}s;
                    animation-delay: ${Math.random() * 5}s;
                `;
                starfield.appendChild(star);
            }
        }

        // ========== –ó–ê–ü–£–°–ö ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

            createStarfield();
            await initColoring();

            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ä–∞–∑–º–µ—Ä—É –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (originalImage) {
                    setupOptimalCanvasSize(originalImage.width, originalImage.height);
                    drawImageSimple(originalImage);
                }
            });
        });
    </script>
</body>
</html>